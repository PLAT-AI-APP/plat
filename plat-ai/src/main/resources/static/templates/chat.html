<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLAT í˜ë¥´ì†Œë‚˜ ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
    <script src="/js/chat.js"></script>
    <link rel="stylesheet" href="/css/chat.css">
</head>
<body>
<div class="chat-container">
    <div class="chat-header">
        <h1>PLAT í˜ë¥´ì†Œë‚˜ ì±„íŒ…</h1>
        <p>ì°ë”° ë£¸ë©”ê°€ ì—¬ì'TS'ê°€ ëë‹¤</p>
    </div>

    <div class="chat-messages" id="chatMessages">
    </div>

    <div class="loading" id="loading">AIê°€ ì‘ë‹µ ì¤‘ì…ë‹ˆë‹¤...</div>

    <div class="chat-input-container">
        <div class="chat-input-wrapper">
            <input
                    type="text"
                    class="chat-input"
                    id="messageInput"
                    placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                    onkeypress="handleKeyPress(event)"
            />
            <button class="send-button" onclick="sendMessage()" id="sendButton">
                ì „ì†¡
            </button>
        </div>
    </div>

    <div class="controls">
        <button class="control-button" onclick="clearChat()">ëŒ€í™” ì´ˆê¸°í™”</button>
        <button class="control-button" onclick="viewHistory()">íˆìŠ¤í† ë¦¬ ë³´ê¸°</button>
    </div>
</div>

<script>
    const SESSION_ID = 'session-' + Date.now();
    const API_BASE_URL = 'http://localhost:8080/api/chat';

    const socket = new ChatSocket(`${API_BASE_URL}/stream`, 'CLAUDE_SONNET_4_5')
        .error(error => {
            console.error('ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:', error);
            addMessage('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'assistant');
        })
        .finally(() => {
            document.getElementById('sendButton').disabled = false;
            document.getElementById('loading').classList.remove('active');
        })

    window.onload = async () => {
        try {
            await fetch(`${API_BASE_URL}/session/${SESSION_ID}/start`, { method: 'POST' });
        } catch (error) {
            console.error('ì„¸ì…˜ ì‹œì‘ ì˜¤ë¥˜:', error);
        }
    };

    function handleKeyPress(event) {
        if (event.key === 'Enter') sendMessage();
    }

    /**
     * AI ì‘ë‹µ í…ìŠ¤íŠ¸ë¥¼ ë¸”ë¡ ë‹¨ìœ„ë¡œ íŒŒì‹±
     * - "ëŒ€ì‚¬" â†’ dialogue
     * - 'ë…ë°±' â†’ thought
     * - > ì„ íƒì§€ â†’ choice
     * - ```INFO ... ``` â†’ info
     * - ë‚˜ë¨¸ì§€ â†’ narration
     */
    function parseBlocks(text) {
        const blocks = [];
        // \n\n ìœ¼ë¡œ ë¬¸ë‹¨ ë¶„ë¦¬
        const paragraphs = text.split('\n\n');

        let inInfoBlock = false;
        let infoContent = '';

        for (const para of paragraphs) {
            const trimmed = para.trim();
            if (!trimmed) continue;

            // INFO ë¸”ë¡ ì‹œì‘
            if (trimmed.startsWith('```INFO') || trimmed.startsWith('```info')) {
                inInfoBlock = true;
                infoContent = trimmed.replace(/^```INFO\s*/i, '');
                // ê°™ì€ ë¬¸ë‹¨ì—ì„œ ë‹«íˆëŠ” ê²½ìš°
                if (infoContent.includes('```')) {
                    infoContent = infoContent.replace(/```\s*$/, '');
                    blocks.push({ type: 'info', content: infoContent.trim() });
                    inInfoBlock = false;
                    infoContent = '';
                }
                continue;
            }

            // INFO ë¸”ë¡ ì§„í–‰ì¤‘
            if (inInfoBlock) {
                if (trimmed.includes('```')) {
                    infoContent += '\n\n' + trimmed.replace(/```\s*$/, '');
                    blocks.push({ type: 'info', content: infoContent.trim() });
                    inInfoBlock = false;
                    infoContent = '';
                } else {
                    infoContent += '\n\n' + trimmed;
                }
                continue;
            }

            // ì„ íƒì§€ (> ë¡œ ì‹œì‘í•˜ëŠ” ì¤„ë“¤)
            const lines = trimmed.split('\n');
            if (lines.every(l => l.trim().startsWith('>'))) {
                for (const line of lines) {
                    const choiceText = line.trim().replace(/^>\s*/, '');
                    if (choiceText) blocks.push({ type: 'choice', content: choiceText });
                }
                continue;
            }

            // ì„ íƒì§€ê°€ ë‹¤ë¥¸ ë¸”ë¡ê³¼ ì„ì¸ ê²½ìš° ì¤„ ë‹¨ìœ„ ì²˜ë¦¬
            let hasChoice = false;
            const nonChoiceLines = [];
            for (const line of lines) {
                if (line.trim().startsWith('>')) {
                    // ì„ íƒì§€ ì „ì— ìŒ“ì¸ ì¼ë°˜ í…ìŠ¤íŠ¸ ì²˜ë¦¬
                    if (nonChoiceLines.length > 0) {
                        classifyParagraph(nonChoiceLines.join('\n'), blocks);
                        nonChoiceLines.length = 0;
                    }
                    const choiceText = line.trim().replace(/^>\s*/, '');
                    if (choiceText) blocks.push({ type: 'choice', content: choiceText });
                    hasChoice = true;
                } else {
                    nonChoiceLines.push(line);
                }
            }
            if (nonChoiceLines.length > 0) {
                classifyParagraph(nonChoiceLines.join('\n'), blocks);
            }
            if (!hasChoice && nonChoiceLines.length === 0) {
                classifyParagraph(trimmed, blocks);
            }
        }

        // INFO ë¸”ë¡ì´ ë‹«íˆì§€ ì•Šì€ ì±„ ëë‚¨ (ìŠ¤íŠ¸ë¦¬ë° ì¤‘)
        if (inInfoBlock && infoContent.trim()) {
            blocks.push({ type: 'info', content: infoContent.trim() });
        }

        return blocks;
    }

    function classifyParagraph(text, blocks) {
        const trimmed = text.trim();
        if (!trimmed) return;

        // "ëŒ€ì‚¬" â€” í°ë”°ì˜´í‘œë¡œ ì‹œì‘
        if (trimmed.startsWith('"')) {
            // ë‹«ëŠ” ë”°ì˜´í‘œ ì œê±°
            let content = trimmed;
            if (content.endsWith('"')) {
                content = content.slice(1, -1);
            } else {
                content = content.slice(1);
            }
            blocks.push({ type: 'dialogue', content });
            return;
        }

        // 'ë…ë°±' â€” ì‘ì€ë”°ì˜´í‘œë¡œ ì‹œì‘
        if (trimmed.startsWith("'")) {
            let content = trimmed;
            if (content.endsWith("'")) {
                content = content.slice(1, -1);
            } else {
                content = content.slice(1);
            }
            blocks.push({ type: 'thought', content });
            return;
        }

        // ë‚˜ë¨¸ì§€ëŠ” ë‚˜ë ˆì´ì…˜
        blocks.push({ type: 'narration', content: trimmed });
    }

    /**
     * íŒŒì‹±ëœ ë¸”ë¡ ë°°ì—´ì„ HTMLë¡œ ë Œë”ë§
     */
    function renderBlocks(blocks) {
        let html = '';
        let choicesHtml = '';
        let choiceCount = 0;

        for (const block of blocks) {
            switch (block.type) {
                case 'dialogue':
                    html += `<div class="block-dialogue">"${escapeHtml(block.content)}"</div>`;
                    break;
                case 'thought':
                    html += `<div class="block-thought">'${escapeHtml(block.content)}'</div>`;
                    break;
                case 'narration':
                    html += `<div class="block-narration">${escapeHtml(block.content)}</div>`;
                    break;
                case 'choice':
                    choicesHtml += `<button class="block-choice" data-raw="${escapeAttr(block.content)}" onclick="sendChoice(this.dataset.raw)">${formatChoice(block.content)}</button>`;
                    choiceCount++;
                    break;
                case 'info':
                    html += renderInfoBlock(block.content);
                    break;
            }
        }

        // ì„ íƒì§€ ëª¨ì•„ì„œ ì¶œë ¥
        if (choiceCount > 0) {
            // ì„ íƒì§€ëŠ” info ë¸”ë¡ ì•ì— ì‚½ì…
            const infoIdx = html.lastIndexOf('<div class="block-info"');
            const choicesBlock = `<div class="block-choices">${choicesHtml}</div>`;
            if (infoIdx > -1) {
                html = html.slice(0, infoIdx) + choicesBlock + html.slice(infoIdx);
            } else {
                html += choicesBlock;
            }
        }

        return html;
    }

    function renderInfoBlock(content) {
        const lines = content.split('\n');
        let nameHtml = '';
        const bodyLines = [];

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            if (i === 0 && !line.startsWith('ğŸ“') && !line.startsWith('ğŸ•')) {
                nameHtml = `<div class="info-name">${escapeHtml(line)}</div>`;
            } else {
                bodyLines.push(`<div class="info-line">${escapeHtml(line)}</div>`);
            }
        }

        return `<div class="block-info">${nameHtml}${bodyLines.join('')}</div>`;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function escapeAttr(text) {
        return text.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function formatChoice(text) {
        return escapeHtml(text).replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    }

    /**
     * ì„ íƒì§€ í´ë¦­ ì‹œ í•´ë‹¹ í…ìŠ¤íŠ¸ë¥¼ ë©”ì‹œì§€ë¡œ ì „ì†¡
     */
    function sendChoice(text) {
        document.getElementById('messageInput').value = text;
        sendMessage();
    }

    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        if (!message) return;

        addMessage(message, 'user');
        input.value = '';

        document.getElementById('sendButton').disabled = true;
        document.getElementById('loading').classList.add('active');

        let messageElement = null;
        await socket.stream(message, fullText => {
            const blocks = parseBlocks(fullText);
            const html = renderBlocks(blocks);

            if (!messageElement) {
                messageElement = addMessage('', 'assistant');
            }

            messageElement.querySelector('.message-content').innerHTML = html;
            scrollToBottom();
        })
    }

    function addMessage(content, role) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';

        if (role === 'assistant' && content) {
            const blocks = parseBlocks(content);
            contentDiv.innerHTML = renderBlocks(blocks);
        } else if (role === 'user') {
            contentDiv.textContent = content;
        }

        messageDiv.appendChild(contentDiv);
        messagesContainer.appendChild(messageDiv);
        scrollToBottom();
        return messageDiv;
    }

    function scrollToBottom() {
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    async function clearChat() {
        if (!confirm('ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            await fetch(`${API_BASE_URL}/session/${SESSION_ID}`, { method: 'DELETE' });
            document.getElementById('chatMessages').innerHTML = '';
            alert('ëŒ€í™” íˆìŠ¤í† ë¦¬ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (error) {
            console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            alert('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    async function viewHistory() {
        try {
            const response = await fetch(`${API_BASE_URL}/session/${SESSION_ID}/history`);
            const data = await response.json();
            alert('ëŒ€í™” íˆìŠ¤í† ë¦¬:\n\n' + data.history);
        } catch (error) {
            console.error('íˆìŠ¤í† ë¦¬ ì¡°íšŒ ì˜¤ë¥˜:', error);
            alert('íˆìŠ¤í† ë¦¬ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
</script>
</body>
</html>
